# WORKLOG

- Init consolidated repo.
- Implemented eBPF handshake correlation (Task 01):
	- Added TID-keyed cache with 2s TTL, metrics logging every 5s.
	- Metrics: eventsReceived, handshakesEmitted, correlationTimeouts, cacheEvictions, kernel_drops.
	- Output aggregated handshake JSONL to runtime.jsonl.
	- Commands:
		- cd carnot-agent/ebpf-core; make
		- cd go-loader && go build -o bin/carnot-ebpf-loader ./...
		- sudo ./bin/carnot-ebpf-loader -obj ../openssl_handshake.bpf.o -out runtime.jsonl -libssl /lib/x86_64-linux-gnu/libssl.so.3
		- curl -sS https://example.org >$null
	- Expected: runtime.jsonl lines containing pid, tid, sni, groups_offered, success; low kernel_drops & correlationTimeouts.
- Task 01b (Negotiated Group Extraction):
	- Added optional cgo shim (dlopen/dlsym) to call SSL_get_shared_group if exported.
	- (Replaced) Kernel uretprobes now emit EVT_GROUP_SELECTED; legacy cgo path removed for simplicity and portability.
	- Emits negotiated group via eBPF events; hybrid group ID mapping placeholder retained.
- Task 02 (Runtime → CryptoBOM v2.1):
	- Implemented integrations/runtime/ebpf_to_bom.py converting runtime.jsonl handshakes into runtime.bom.json observations.
	- Adds bom_ref, counts unique SNIs, includes success flag & negotiated group.
	- Merge command (example):
		- python integrations/runtime/ebpf_to_bom.py --in artifacts/run1/runtime.jsonl --out artifacts/run1/runtime.bom.json --asset-id host:demo
		- carnot-merge artifacts/run1/static.bom.json artifacts/run1/runtime.bom.json artifacts/run1/aws.bom.json -o artifacts/run1/merged.json
- Task 03 (AWS Inventory Tests & Defaults):
	- Added defaults for untagged assets and tag extraction logic in aws_inventory.py.
	- Implemented retry handling for throttling (exponential backoff).
	- Created moto-based tests for pagination, defaults, throttling resilience.
	- Added GitHub Actions workflow .github/workflows/tests.yml to run pytest.
- Task 04 (OPA Gate Warn → Enforce Prep):
	- Expanded pqc_migration.rego with rules (rsa_min_key_size, legacy_hash_function, missing_hybrid_support, untagged_cloud_key) and remediation messages referencing docs/POLICY_GUIDE.md.
	- Added docs/POLICY_GUIDE.md for remediation guidance.
	- Replaced policy-gate workflow to evaluate policy, upload opa_result.json & opa_summary.json, and comment on PRs.
	- Added workflow_dispatch input 'enforce' (default false) to later enable blocking.
- Task 05 (Cloud Run Attestation API):
	- Added FastAPI service (api/main.py) with POST /attest producing JSON + markdown attestation.
	- Dockerfile & requirements.txt created; deploy script scripts/deploy_cloud_run.sh for gcloud run deploy.
	- Attestation includes HNDL exposure approximation and policy status.
- Task 06 (Site Deploy & Samples):
	- Added static site scaffold at `carnot-site/index.html` (pipeline overview, quick start, roadmap).
	- Published sample attestation artifacts (`docs/samples/sample_attestation.json`, `.md`).
	- Added PCAP walkthrough (`docs/samples/pcap_walkthrough.html`).
	- Added GitHub Actions workflow `.github/workflows/site.yml` to deploy to Cloudflare Pages (project: carnotengine-site).
	- Deployed via Wrangler to Cloudflare Pages project `carnotengine`.
	- Live URL: https://carnotengine.pages.dev (samples accessible under /docs/samples/).
- Task 07 (Stress & Overhead Measurement):
	- Added extended `scripts/stress_test.sh` capturing p95/p99 HTTP latency, throughput, handshake latency percentiles.
	- Computes correlation_failure_rate & kernel_drop_rate from loader metrics.
	- Emits `metrics.json` and markdown summary `docs/OVERHEAD_RESULTS.md`.
	- Windows placeholder run (no eBPF) recorded baseline (p95=~70ms, p99=~563ms @ ~17 rps).
	- Linux run (GitHub Actions run #14) produced handshake metrics & kernel drop stats (artifact: stress-metrics). Repository docs update in progress.
	- Added `drop_counters` BPF array map (index 0) tracking ring buffer reservation failures and `SMALL_RB` build flag to intentionally induce drops during stress validation. Loader now reports `kernel_drops` and `kernel_drop_rate` (drops / eventsReceived).
- Added GitHub Actions workflow `.github/workflows/stress.yml` to run full Linux stress test (build eBPF + Go loader, run harness, upload metrics artifacts) so we can collect real handshake correlation & kernel drop metrics without needing local Linux host.
- Task 08 (Attestation Visualization):
	- Added Sankey diagram + optional violations bar chart generator (`carnot-attest/report_viz.py`).
	- Integrated into `scripts/run_assessment.sh` (step 7) generating `hndl_sankey.png` and `hndl_sankey_violations.png` when OPA results present.
	- OPA step now emits machine-readable `opa_result.json` for visualization.
	- PNG artifacts included in assessment bundle zip.
- Task 09 (Assessment One-Pager & Outreach):
	- Added `docs/ASSESSMENT_TEMPLATE.md` with logo/contact placeholders and structured sections (executive summary, findings, roadmap).
	- Added `docs/EMAIL_OUTREACH.md` including target list table (10 slots), initial + follow-up email templates, and metrics tracking.
	- Next: generate branded PDF to `docs/sales/` and record outreach metrics after sending.
- Task 10 (WORKLOG Enforcement):
	- Added `.github/workflows/worklog-check.yml` to enforce WORKLOG.md change or `worklog-bypass` label; skips draft PRs.
- Task 11 (E2E & Release Bundle):
	- Added `scripts/build_release_bundle.sh` (Linux) and `scripts/build_release_bundle.ps1` (Windows) bundling `artifacts/assessment-*/` into `dist/` with manifest.
	- Release workflow updated to run minimal assessment (skip eBPF/AWS) and build bundles on tag `v*.*.*` before publishing GitHub Release.
	- Initial tag `v0.1.0` failed (setuptools multiple top-level packages for `carnot-merge`). Fixed by refining `pyproject.toml` (explicit setuptools discovery config).
	- Tags `v0.1.1` and `v0.1.2` surfaced OPA rego parse errors (OPA 1.0 syntax changes). Updated `policies/pqc_migration.rego` to 1.0 style (`contains` + `if`).
	- Made OPA eval non-fatal in `scripts/run_assessment.sh` (continues with empty violations on policy issues) to keep release resilient.
	- Added visualization integration already producing `hndl_sankey.png`; violations chart appears once policy parses cleanly.
	- Tag `v0.1.3` (policy fixes) still failed: GitHub Release step 403 (missing contents: write permission on default token).
	- Added workflow `permissions: contents: write` and re-tagged `v0.1.4` → SUCCESS: release published with `assessment-<timestamp>.zip` + `assessments_manifest.json` assets.
	- Visualization step previously errored (missing matplotlib); dependency now added so future releases include PNG charts.
	- Next: Enrich release notes body (auto-generate summary + violation counts) and include SHA256 of bundle in manifest for integrity.
